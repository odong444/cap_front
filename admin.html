<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìº¡ì±  í’€ì´ - ê´€ë¦¬ì</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* ë¡œê·¸ì¸ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 350px;
        }
        .login-box h1 { text-align: center; margin-bottom: 30px; }
        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .login-box button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* ë ˆì´ì•„ì›ƒ */
        .admin-container { display: flex; min-height: 100vh; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 250px;
            background: #1a1a2e;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .sidebar-header h2 { font-size: 18px; }
        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: #aaa;
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #16213e;
            color: white;
            border-left: 3px solid #667eea;
        }
        .sidebar-menu a span { margin-right: 10px; }
        
        /* ë©”ì¸ */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
        }
        
        /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #333; }
        .stat-card .sub { font-size: 12px; color: #999; margin-top: 5px; }
        .stat-card.primary { border-left: 4px solid #667eea; }
        .stat-card.success { border-left: 4px solid #28a745; }
        .stat-card.warning { border-left: 4px solid #ffc107; }
        .stat-card.danger { border-left: 4px solid #dc3545; }
        
        /* í…Œì´ë¸” */
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h3 { font-size: 18px; }
        .card-body { padding: 20px; }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th { background: #f8f9fa; font-weight: 600; color: #666; }
        tr:hover { background: #f8f9fa; }
        
        /* ë²„íŠ¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        
        /* ì…ë ¥ */
        .form-control {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-control:focus { outline: none; border-color: #667eea; }
        
        /* í•„í„° */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters select, .filters input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* ë°°ì§€ */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #cce5ff; color: #004085; }
        .badge-secondary { background: #e9ecef; color: #495057; }
        
        /* ì²´í¬ë°•ìŠ¤ */
        .checkbox-cell { width: 40px; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        
        /* ë©”ëª¨ ì…ë ¥ */
        .memo-input {
            width: 150px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }
        .memo-input:focus { border-color: #667eea; outline: none; }
        
        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            min-width: 400px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h3 { margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        .hidden { display: none !important; }
        
        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #333;
            color: white;
            border-radius: 10px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <input type="password" id="admin-password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" 
                   onkeypress="if(event.keyCode==13) adminLogin()">
            <button onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
    </div>
    
    <!-- ê´€ë¦¬ì í™”ë©´ -->
    <div id="admin-screen" class="admin-container hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¯ ìº¡ì±  ê´€ë¦¬ì</h2>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="active" onclick="showPage('dashboard')"><span>ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ</a>
                <a href="#" onclick="showPage('results')"><span>ğŸ“‹</span> ìˆ˜ì§‘ ê²°ê³¼</a>
                <a href="#" onclick="showPage('users')"><span>ğŸ‘¥</span> ìœ ì € ê´€ë¦¬</a>
                <a href="#" onclick="showPage('tasks')"><span>ğŸ“</span> ì‘ì—… ê´€ë¦¬</a>
                <a href="#" onclick="showPage('withdrawals')"><span>ğŸ§</span> ì¶œê¸ˆ ê´€ë¦¬</a>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="page-dashboard">
                <h2 style="margin-bottom: 20px;">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                <div class="stats-grid" id="stats-grid"></div>
            </div>
            
            <!-- ìˆ˜ì§‘ ê²°ê³¼ -->
            <div id="page-results" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ“‹ ìˆ˜ì§‘ ê²°ê³¼</h2>
                
                <div class="filters">
                    <select id="results-filter-used" onchange="loadResults()">
                        <option value="">ì „ì²´</option>
                        <option value="false">ë¯¸ì‚¬ìš©</option>
                        <option value="true">ì‚¬ìš©ì™„ë£Œ</option>
                    </select>
                    <input type="text" id="results-search" placeholder="ìŠ¤í† ì–´ëª…/ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰" 
                           onkeypress="if(event.keyCode==13) loadResults()">
                    <button class="btn btn-primary" onclick="loadResults()">ê²€ìƒ‰</button>
                    <button class="btn btn-secondary" onclick="exportResults()">CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>ìˆ˜ì§‘ëœ íŒë§¤ì ì •ë³´</h3>
                        <div>
                            <button class="btn btn-sm btn-success" onclick="bulkUpdateUsed(true)">ì„ íƒ ì‚¬ìš©ì™„ë£Œ</button>
                            <button class="btn btn-sm btn-secondary" onclick="bulkUpdateUsed(false)">ì„ íƒ ë¯¸ì‚¬ìš©</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th class="checkbox-cell"><input type="checkbox" onchange="toggleAllResults(this)"></th>
                                    <th>ìŠ¤í† ì–´ëª…</th>
                                    <th>ìƒí˜¸ëª…</th>
                                    <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                                    <th>ëŒ€í‘œì</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ì´ë©”ì¼</th>
                                    <th>ì‚¬ìš©</th>
                                    <th>ë©”ëª¨</th>
                                    <th>ìˆ˜ì§‘ì¼</th>
                                </tr>
                            </thead>
                            <tbody id="results-table"></tbody>
                        </table>
                        <div class="pagination" id="results-pagination"></div>
                    </div>
                </div>
            </div>
            
            <!-- ìœ ì € ê´€ë¦¬ -->
            <div id="page-users" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ‘¥ ìœ ì € ê´€ë¦¬</h2>
                
                <div class="filters">
                    <input type="text" id="users-search" placeholder="ìœ ì € ê²€ìƒ‰" 
                           onkeypress="if(event.keyCode==13) loadUsers()">
                    <button class="btn btn-primary" onclick="loadUsers()">ê²€ìƒ‰</button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì•„ì´ë””</th>
                                    <th>ë³´ìœ  í¬ì¸íŠ¸</th>
                                    <th>í•´ê²° ìˆ˜</th>
                                    <th>ê°€ì…ì¼</th>
                                    <th>ìµœê·¼ ë¡œê·¸ì¸</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="users-table"></tbody>
                        </table>
                        <div class="pagination" id="users-pagination"></div>
                    </div>
                </div>
            </div>
            
            <!-- ì‘ì—… ê´€ë¦¬ -->
            <div id="page-tasks" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ“ ì‘ì—… ê´€ë¦¬</h2>
                
                <div class="filters">
                    <select id="tasks-filter-status" onchange="loadTasks()">
                        <option value="">ì „ì²´</option>
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="assigned">ì§„í–‰ì¤‘</option>
                        <option value="completed">ì™„ë£Œ</option>
                    </select>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ìŠ¤í† ì–´ëª…</th>
                                    <th>í‚¤ì›Œë“œ</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ë‹´ë‹¹ì</th>
                                    <th>ìƒì„±ì¼</th>
                                    <th>ì™„ë£Œì¼</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table"></tbody>
                        </table>
                        <div class="pagination" id="tasks-pagination"></div>
                    </div>
                </div>
            </div>
            
            <!-- ì¶œê¸ˆ ê´€ë¦¬ -->
            <div id="page-withdrawals" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ§ ì¶œê¸ˆ ê´€ë¦¬</h2>
                
                <div class="filters">
                    <select id="withdrawals-filter-status" onchange="loadWithdrawals()">
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="completed">ì™„ë£Œ</option>
                        <option value="rejected">ê±°ì ˆ</option>
                    </select>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ìœ ì €</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ì€í–‰</th>
                                    <th>ê³„ì¢Œë²ˆí˜¸</th>
                                    <th>ì˜ˆê¸ˆì£¼</th>
                                    <th>í˜„ì¬ì”ì•¡</th>
                                    <th>ì‹ ì²­ì¼</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë¦¬ì›Œë“œ ì¡°ì • ëª¨ë‹¬ -->
    <div id="reward-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeRewardModal()">
        <div class="modal">
            <h3>ğŸ’° ë¦¬ì›Œë“œ ì¡°ì •</h3>
            <p style="margin-bottom: 15px;">ìœ ì €: <strong id="modal-user-id"></strong></p>
            <input type="number" id="modal-amount" class="form-control" placeholder="ì¡°ì • ê¸ˆì•¡ (+/-)">
            <input type="text" id="modal-reason" class="form-control" placeholder="ì‚¬ìœ " style="margin-top: 10px;">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeRewardModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitRewardAdjust()">ì ìš©</button>
            </div>
        </div>
    </div>

<script>
// ==================== ì„¤ì • ====================
const API_SERVER = 'capapi-production.up.railway.app';  // Railway URLë¡œ ìˆ˜ì •

let currentPage = {
    results: 1,
    users: 1,
    tasks: 1
};

// ==================== ë¡œê·¸ì¸ ====================
function adminLogin() {
    const password = document.getElementById('admin-password').value;
    
    fetch(API_SERVER + '/api/admin/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({password})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
            loadDashboard();
        } else {
            alert(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
        }
    });
}

// ==================== í˜ì´ì§€ ì „í™˜ ====================
function showPage(page) {
    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
    document.getElementById('page-' + page).classList.remove('hidden');
    
    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'results': loadResults(); break;
        case 'users': loadUsers(); break;
        case 'tasks': loadTasks(); break;
        case 'withdrawals': loadWithdrawals(); break;
    }
}

// ==================== ëŒ€ì‹œë³´ë“œ ====================
function loadDashboard() {
    fetch(API_SERVER + '/api/admin/stats')
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            const s = data.stats;
            
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card primary">
                    <h3>ì´ ìˆ˜ì§‘ ê²°ê³¼</h3>
                    <div class="value">${s.total_results.toLocaleString()}</div>
                    <div class="sub">ì˜¤ëŠ˜ +${s.today_results}</div>
                </div>
                <div class="stat-card success">
                    <h3>ì‚¬ìš© ì™„ë£Œ</h3>
                    <div class="value">${s.used_results.toLocaleString()}</div>
                    <div class="sub">ë¯¸ì‚¬ìš© ${(s.total_results - s.used_results).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>ì´ ìœ ì €</h3>
                    <div class="value">${s.total_users.toLocaleString()}</div>
                    <div class="sub">ì˜¤ëŠ˜ ê°€ì… +${s.today_users}</div>
                </div>
                <div class="stat-card warning">
                    <h3>ëŒ€ê¸° ì¤‘ ì‘ì—…</h3>
                    <div class="value">${s.pending_tasks.toLocaleString()}</div>
                    <div class="sub">ì§„í–‰ ì¤‘ ${s.assigned_tasks}</div>
                </div>
                <div class="stat-card">
                    <h3>ì´ ì§€ê¸‰ í¬ì¸íŠ¸</h3>
                    <div class="value">${s.total_rewards.toLocaleString()}P</div>
                </div>
                <div class="stat-card danger">
                    <h3>ì¶œê¸ˆ ëŒ€ê¸°</h3>
                    <div class="value">${s.pending_withdrawals}ê±´</div>
                    <div class="sub">${s.pending_withdraw_amount.toLocaleString()}P</div>
                </div>
            `;
        });
}

// ==================== ìˆ˜ì§‘ ê²°ê³¼ ====================
function loadResults(page = 1) {
    currentPage.results = page;
    const used = document.getElementById('results-filter-used').value;
    const search = document.getElementById('results-search').value;
    
    const params = new URLSearchParams({page, per_page: 30});
    if (used) params.append('used', used);
    if (search) params.append('search', search);
    
    fetch(API_SERVER + '/api/admin/results?' + params)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            
            const tbody = document.getElementById('results-table');
            tbody.innerHTML = data.results.map(r => `
                <tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" class="result-checkbox" value="${r.id}">
                    </td>
                    <td><a href="${r.store_url}" target="_blank">${r.store_name || '-'}</a></td>
                    <td>${r.seller_name || '-'}</td>
                    <td>${r.business_number || '-'}</td>
                    <td>${r.representative || '-'}</td>
                    <td>${r.phone || '-'}</td>
                    <td>${r.email || '-'}</td>
                    <td>
                        <input type="checkbox" ${r.used ? 'checked' : ''} 
                               onchange="updateResultUsed(${r.id}, this.checked)">
                    </td>
                    <td>
                        <input type="text" class="memo-input" value="${r.memo || ''}" 
                               placeholder="ë©”ëª¨" onblur="updateResultMemo(${r.id}, this.value)">
                    </td>
                    <td>${formatDate(r.created_at)}</td>
                </tr>
            `).join('');
            
            renderPagination('results', data.total, data.page, data.per_page);
        });
}

function updateResultUsed(id, used) {
    fetch(API_SERVER + `/api/admin/results/${id}/update`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({used})
    }).then(() => showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ'));
}

function updateResultMemo(id, memo) {
    fetch(API_SERVER + `/api/admin/results/${id}/update`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({memo})
    });
}

function toggleAllResults(checkbox) {
    document.querySelectorAll('.result-checkbox').forEach(cb => cb.checked = checkbox.checked);
}

function bulkUpdateUsed(used) {
    const ids = Array.from(document.querySelectorAll('.result-checkbox:checked')).map(cb => parseInt(cb.value));
    if (!ids.length) return alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    
    fetch(API_SERVER + '/api/admin/results/bulk-update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids, used})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.updated}ê°œ ì—…ë°ì´íŠ¸`);
            loadResults(currentPage.results);
        }
    });
}

function exportResults() {
    const used = document.getElementById('results-filter-used').value;
    
    fetch(API_SERVER + '/api/admin/results/export?used=' + used)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            
            const headers = ['ìŠ¤í† ì–´ëª…', 'ìƒí˜¸ëª…', 'ì‚¬ì—…ìë²ˆí˜¸', 'ëŒ€í‘œì', 'ì—°ë½ì²˜', 'ì´ë©”ì¼', 'ì£¼ì†Œ', 'URL', 'ì‚¬ìš©', 'ë©”ëª¨', 'ìˆ˜ì§‘ì¼'];
            const rows = data.results.map(r => [
                r.store_name, r.seller_name, r.business_number, r.representative,
                r.phone, r.email, r.address, r.store_url, r.used ? 'Y' : 'N', r.memo, r.created_at
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c || ''}"`).join(','))].join('\n');
            const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `results_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });
}

// ==================== ìœ ì € ê´€ë¦¬ ====================
function loadUsers(page = 1) {
    currentPage.users = page;
    const search = document.getElementById('users-search').value;
    
    const params = new URLSearchParams({page, per_page: 30});
    if (search) params.append('search', search);
    
    fetch(API_SERVER + '/api/admin/users?' + params)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td>${u.user_id}</td>
                    <td>${u.rewards.toLocaleString()}P</td>
                    <td>${u.solved_count}</td>
                    <td>${formatDate(u.created_at)}</td>
                    <td>${u.last_login ? formatDate(u.last_login) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openRewardModal('${u.user_id}')">
                            ë¦¬ì›Œë“œ ì¡°ì •
                        </button>
                    </td>
                </tr>
            `).join('');
            
            renderPagination('users', data.total, data.page, data.per_page);
        });
}

function openRewardModal(userId) {
    document.getElementById('modal-user-id').textContent = userId;
    document.getElementById('modal-amount').value = '';
    document.getElementById('modal-reason').value = '';
    document.getElementById('reward-modal').classList.remove('hidden');
}

function closeRewardModal() {
    document.getElementById('reward-modal').classList.add('hidden');
}

function submitRewardAdjust() {
    const userId = document.getElementById('modal-user-id').textContent;
    const amount = parseInt(document.getElementById('modal-amount').value);
    const reason = document.getElementById('modal-reason').value || 'ê´€ë¦¬ì ì¡°ì •';
    
    if (!amount) return alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');
    
    fetch(API_SERVER + `/api/admin/users/${userId}/adjust-rewards`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({amount, reason})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('ë¦¬ì›Œë“œ ì¡°ì • ì™„ë£Œ');
            closeRewardModal();
            loadUsers(currentPage.users);
        }
    });
}

// ==================== ì‘ì—… ê´€ë¦¬ ====================
function loadTasks(page = 1) {
    currentPage.tasks = page;
    const status = document.getElementById('tasks-filter-status').value;
    
    const params = new URLSearchParams({page, per_page: 30});
    if (status) params.append('status', status);
    
    fetch(API_SERVER + '/api/admin/tasks?' + params)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            
            const statusBadge = {
                pending: '<span class="badge badge-warning">ëŒ€ê¸°ì¤‘</span>',
                assigned: '<span class="badge badge-info">ì§„í–‰ì¤‘</span>',
                completed: '<span class="badge badge-success">ì™„ë£Œ</span>'
            };
            
            const tbody = document.getElementById('tasks-table');
            tbody.innerHTML = data.tasks.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td><a href="${t.store_url}" target="_blank">${t.store_name || '-'}</a></td>
                    <td>${t.keyword || '-'}</td>
                    <td>${statusBadge[t.status] || t.status}</td>
                    <td>${t.assigned_to || '-'}</td>
                    <td>${formatDate(t.created_at)}</td>
                    <td>${t.completed_at ? formatDate(t.completed_at) : '-'}</td>
                </tr>
            `).join('');
            
            renderPagination('tasks', data.total, data.page, data.per_page);
        });
}

// ==================== ì¶œê¸ˆ ê´€ë¦¬ ====================
function loadWithdrawals() {
    const status = document.getElementById('withdrawals-filter-status').value;
    
    fetch(API_SERVER + '/api/admin/withdrawals?status=' + status)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            
            const tbody = document.getElementById('withdrawals-table');
            tbody.innerHTML = data.withdrawals.map(w => `
                <tr>
                    <td>${w.user_id}</td>
                    <td>${w.amount.toLocaleString()}P</td>
                    <td>${w.bank_name}</td>
                    <td>${w.account_number}</td>
                    <td>${w.account_holder}</td>
                    <td>${(w.current_rewards || 0).toLocaleString()}P</td>
                    <td>${formatDate(w.created_at)}</td>
                    <td>
                        ${w.status === 'pending' ? `
                            <button class="btn btn-sm btn-success" onclick="processWithdrawal(${w.id}, 'approve')">ìŠ¹ì¸</button>
                            <button class="btn btn-sm btn-danger" onclick="processWithdrawal(${w.id}, 'reject')">ê±°ì ˆ</button>
                        ` : `
                            <span class="badge ${w.status === 'completed' ? 'badge-success' : 'badge-danger'}">
                                ${w.status === 'completed' ? 'ì™„ë£Œ' : 'ê±°ì ˆ'}
                            </span>
                        `}
                    </td>
                </tr>
            `).join('');
        });
}

function processWithdrawal(id, action) {
    const actionText = action === 'approve' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ';
    if (!confirm(`ì¶œê¸ˆ ìš”ì²­ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    fetch(API_SERVER + `/api/admin/withdrawals/${id}/process`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(`ì¶œê¸ˆ ${actionText} ì™„ë£Œ`);
            loadWithdrawals();
        }
    });
}

// ==================== ìœ í‹¸ë¦¬í‹° ====================
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function renderPagination(type, total, page, perPage) {
    const totalPages = Math.ceil(total / perPage);
    const container = document.getElementById(type + '-pagination');
    
    let html = `<button ${page <= 1 ? 'disabled' : ''} onclick="load${capitalize(type)}(${page-1})">ì´ì „</button>`;
    
    for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        html += `<button class="${i === page ? 'active' : ''}" onclick="load${capitalize(type)}(${i})">${i}</button>`;
    }
    
    html += `<button ${page >= totalPages ? 'disabled' : ''} onclick="load${capitalize(type)}(${page+1})">ë‹¤ìŒ</button>`;
    html += `<span style="margin-left: 10px; color: #666;">ì´ ${total.toLocaleString()}ê°œ</span>`;
    
    container.innerHTML = html;
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
</body>
</html>
