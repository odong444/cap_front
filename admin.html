<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìº¡ì±  ê´€ë¦¬ì</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }
        
        /* ë¡œê·¸ì¸ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        .login-box h2 { text-align: center; margin-bottom: 30px; }
        .login-box input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .login-box button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* ë ˆì´ì•„ì›ƒ */
        .admin-container { display: none; }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 220px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        .sidebar h2 {
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }
        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #34495e;
            color: white;
        }
        
        .main-content {
            margin-left: 220px;
            padding: 30px;
        }
        
        /* ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-card .label {
            color: #666;
            margin-top: 5px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 20px; }
        
        /* í…Œì´ë¸” */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th { background: #f8f9fa; font-weight: 600; }
        
        /* ë²„íŠ¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        
        /* í¼ */
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .form-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters select, .filters input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .hidden { display: none !important; }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <h2>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸" 
                   onkeypress="if(event.keyCode==13) adminLogin()">
            <button onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
    </div>
    
    <!-- ê´€ë¦¬ì í˜ì´ì§€ -->
    <div id="admin-container" class="admin-container">
        <div class="sidebar">
            <h2>ğŸ›  ê´€ë¦¬ì</h2>
            <div class="sidebar-menu">
                <a href="#" class="active" onclick="showPage('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="#" onclick="showPage('keywords')">ğŸ”‘ í‚¤ì›Œë“œ</a>
                <a href="#" onclick="showPage('results')">ğŸ“‹ ìˆ˜ì§‘ ê²°ê³¼</a>
                <a href="#" onclick="showPage('users')">ğŸ‘¥ ìœ ì €</a>
                <a href="#" onclick="showPage('withdrawals')">ğŸ’° ì¶œê¸ˆ</a>
            </div>
        </div>
        
        <div class="main-content">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="page-dashboard">
                <h2 style="margin-bottom: 20px;">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="stat-results">0</div>
                        <div class="label">ì´ ìˆ˜ì§‘ ê²°ê³¼</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-unused">0</div>
                        <div class="label">ë¯¸ì‚¬ìš© ê²°ê³¼</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-uids">0</div>
                        <div class="label">ëŒ€ê¸° UID</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-sessions">0</div>
                        <div class="label">í™œì„± ì„¸ì…˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-users">0</div>
                        <div class="label">ì´ ìœ ì €</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-today">0</div>
                        <div class="label">ì˜¤ëŠ˜ ìˆ˜ì§‘</div>
                    </div>
                </div>
            </div>
            
            <!-- í‚¤ì›Œë“œ ê´€ë¦¬ -->
            <div id="page-keywords" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ”‘ í‚¤ì›Œë“œ ê´€ë¦¬</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3>ìƒˆ í‚¤ì›Œë“œ ì¶”ê°€</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <input type="text" id="new-keyword" placeholder="í‚¤ì›Œë“œ">
                            <input type="number" id="new-priority" placeholder="ìš°ì„ ìˆœìœ„" value="0" style="max-width: 120px;">
                            <button class="btn btn-primary" onclick="addKeyword()">ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h3>í‚¤ì›Œë“œ ëª©ë¡</h3></div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>í‚¤ì›Œë“œ</th>
                                    <th>ìš°ì„ ìˆœìœ„</th>
                                    <th>í™œì„±í™”</th>
                                    <th>ë“±ë¡ì¼</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="keywords-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ìˆ˜ì§‘ ê²°ê³¼ -->
            <div id="page-results" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ“‹ ìˆ˜ì§‘ ê²°ê³¼</h2>
                
                <div class="filters">
                    <select id="filter-used" onchange="loadResults()">
                        <option value="">ì „ì²´</option>
                        <option value="false">ë¯¸ì‚¬ìš©</option>
                        <option value="true">ì‚¬ìš©ì™„ë£Œ</option>
                    </select>
                    <input type="text" id="filter-search" placeholder="ìŠ¤í† ì–´ëª…/ì‚¬ì—…ìë²ˆí˜¸">
                    <button class="btn btn-primary" onclick="loadResults()">ê²€ìƒ‰</button>
                    <button class="btn btn-success" onclick="exportResults()">CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ìŠ¤í† ì–´</th>
                                    <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                                    <th>ëŒ€í‘œì</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ì´ë©”ì¼</th>
                                    <th>í•´ê²°ì</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ìˆ˜ì§‘ì¼</th>
                                </tr>
                            </thead>
                            <tbody id="results-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ìœ ì € ê´€ë¦¬ -->
            <div id="page-users" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ‘¥ ìœ ì € ê´€ë¦¬</h2>
                
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì•„ì´ë””</th>
                                    <th>í¬ì¸íŠ¸</th>
                                    <th>í•´ê²° ìˆ˜</th>
                                    <th>ê°€ì…ì¼</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ì¶œê¸ˆ ê´€ë¦¬ -->
            <div id="page-withdrawals" class="hidden">
                <h2 style="margin-bottom: 20px;">ğŸ’° ì¶œê¸ˆ ìš”ì²­</h2>
                
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ìœ ì €</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ì€í–‰</th>
                                    <th>ê³„ì¢Œë²ˆí˜¸</th>
                                    <th>ì˜ˆê¸ˆì£¼</th>
                                    <th>ìš”ì²­ì¼</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_SERVER = 'https://capapi-production.up.railway.app';
        
        // ë¡œê·¸ì¸
        async function adminLogin() {
            const password = document.getElementById('admin-password').value;
            
            const resp = await fetch(`${API_SERVER}/api/admin/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password})
            });
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('admin-container').style.display = 'block';
                loadDashboard();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤');
            }
        }
        
        // í˜ì´ì§€ ì „í™˜
        function showPage(page) {
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + page).classList.remove('hidden');
            
            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'keywords': loadKeywords(); break;
                case 'results': loadResults(); break;
                case 'users': loadUsers(); break;
                case 'withdrawals': loadWithdrawals(); break;
            }
        }
        
        // ëŒ€ì‹œë³´ë“œ
        async function loadDashboard() {
            const resp = await fetch(`${API_SERVER}/api/admin/stats`);
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('stat-results').textContent = data.stats.total_results;
                document.getElementById('stat-unused').textContent = data.stats.unused_results;
                document.getElementById('stat-uids').textContent = data.stats.pending_uids;
                document.getElementById('stat-sessions').textContent = data.stats.active_sessions;
                document.getElementById('stat-users').textContent = data.stats.total_users;
                document.getElementById('stat-today').textContent = data.stats.today_results;
            }
        }
        
        // í‚¤ì›Œë“œ
        async function loadKeywords() {
            const resp = await fetch(`${API_SERVER}/api/admin/keywords`);
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('keywords-table').innerHTML = data.keywords.map(k => `
                    <tr>
                        <td><strong>${k.keyword}</strong></td>
                        <td>${k.priority}</td>
                        <td>
                            <input type="checkbox" ${k.is_active ? 'checked' : ''} 
                                   onchange="updateKeyword(${k.id}, 'is_active', this.checked)">
                        </td>
                        <td>${formatDate(k.created_at)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteKeyword(${k.id})">ì‚­ì œ</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        async function addKeyword() {
            const keyword = document.getElementById('new-keyword').value.trim();
            const priority = parseInt(document.getElementById('new-priority').value) || 0;
            
            if (!keyword) return alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            
            await fetch(`${API_SERVER}/api/admin/keywords`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({keyword, priority})
            });
            
            document.getElementById('new-keyword').value = '';
            loadKeywords();
        }
        
        async function updateKeyword(id, field, value) {
            await fetch(`${API_SERVER}/api/admin/keywords/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({[field]: value})
            });
        }
        
        async function deleteKeyword(id) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`${API_SERVER}/api/admin/keywords/${id}`, {method: 'DELETE'});
            loadKeywords();
        }
        
        // ê²°ê³¼
        async function loadResults() {
            const used = document.getElementById('filter-used').value;
            const search = document.getElementById('filter-search').value;
            
            const params = new URLSearchParams();
            if (used) params.append('used', used);
            if (search) params.append('search', search);
            
            const resp = await fetch(`${API_SERVER}/api/admin/results?${params}`);
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('results-table').innerHTML = data.results.map(r => `
                    <tr>
                        <td>${r.store_name || '-'}</td>
                        <td>${r.business_number || '-'}</td>
                        <td>${r.representative || '-'}</td>
                        <td>${r.phone || '-'}</td>
                        <td>${r.email || '-'}</td>
                        <td>${r.solved_by || '-'}</td>
                        <td>
                            <span class="badge ${r.used ? 'badge-success' : 'badge-warning'}">
                                ${r.used ? 'ì‚¬ìš©' : 'ë¯¸ì‚¬ìš©'}
                            </span>
                        </td>
                        <td>${formatDate(r.created_at)}</td>
                    </tr>
                `).join('');
            }
        }
        
        async function exportResults() {
            const resp = await fetch(`${API_SERVER}/api/admin/results/export`);
            const data = await resp.json();
            
            if (data.success) {
                const csv = [
                    ['ìŠ¤í† ì–´', 'ìƒí˜¸ëª…', 'ì‚¬ì—…ìë²ˆí˜¸', 'ëŒ€í‘œì', 'ì—°ë½ì²˜', 'ì´ë©”ì¼', 'ì£¼ì†Œ', 'í•´ê²°ì', 'ìˆ˜ì§‘ì¼'].join(','),
                    ...data.results.map(r => [
                        r.store_name, r.seller_name, r.business_number, r.representative,
                        r.phone, r.email, r.address, r.solved_by, r.created_at
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'results.csv';
                link.click();
            }
        }
        
        // ìœ ì €
        async function loadUsers() {
            const resp = await fetch(`${API_SERVER}/api/admin/users`);
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('users-table').innerHTML = data.users.map(u => `
                    <tr>
                        <td>${u.user_id}</td>
                        <td>${u.rewards.toLocaleString()}P</td>
                        <td>${u.solved_count}</td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" 
                                    onclick="adjustRewards('${u.user_id}')">í¬ì¸íŠ¸ ì¡°ì •</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        async function adjustRewards(userId) {
            const amount = prompt('ì¡°ì •í•  í¬ì¸íŠ¸ (ìŒìˆ˜ ê°€ëŠ¥)');
            if (!amount) return;
            
            await fetch(`${API_SERVER}/api/admin/users/${userId}/adjust-rewards`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({amount: parseInt(amount)})
            });
            
            loadUsers();
        }
        
        // ì¶œê¸ˆ
        async function loadWithdrawals() {
            const resp = await fetch(`${API_SERVER}/api/admin/withdrawals?status=pending`);
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('withdrawals-table').innerHTML = data.withdrawals.map(w => `
                    <tr>
                        <td>${w.user_id}</td>
                        <td>${w.amount.toLocaleString()}P</td>
                        <td>${w.bank_name || '-'}</td>
                        <td>${w.account_number || '-'}</td>
                        <td>${w.account_holder || '-'}</td>
                        <td>${formatDate(w.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="processWithdrawal(${w.id}, 'approve')">ìŠ¹ì¸</button>
                            <button class="btn btn-sm btn-danger" onclick="processWithdrawal(${w.id}, 'reject')">ê±°ì ˆ</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        async function processWithdrawal(id, action) {
            if (!confirm(action === 'approve' ? 'ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            await fetch(`${API_SERVER}/api/admin/withdrawals/${id}/process`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action})
            });
            
            loadWithdrawals();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
    </script>
</body>
</html>
